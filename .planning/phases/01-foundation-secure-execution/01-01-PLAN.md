---
phase: 01-foundation-secure-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sandbox/manager.py
  - src/sandbox/languages.py
  - Dockerfile
  - requirements.txt
  - tests/test_languages.py
  - tests/verify_sandbox.py
autonomous: true
requirements: [SEC-04, ENG-02]
user_setup:
  - service: Docker
    why: "Sandboxed execution environment"
    dashboard_config:
      - task: "Ensure Docker Desktop or Docker Engine is running"
        location: "System Tray / Terminal"
must_haves:
  truths:
    - "The SandboxManager successfully pulls and runs the agent Docker image."
    - "Code execution via the Docker languages returns results from the container environment."
    - "Host system files are not accessible from within the sandbox unless explicitly mounted."
  artifacts:
    - path: "src/sandbox/manager.py"
      provides: "Docker container lifecycle management"
    - path: "src/sandbox/languages.py"
      provides: "Open Interpreter language implementations for Docker"
    - path: "Dockerfile"
      provides: "Agent execution environment definition"
  key_links:
    - from: "src/sandbox/languages.py"
      to: "src/sandbox/manager.py"
      via: "Container instance"
---

<objective>
Establish the secure foundation for IronClaw by implementing a Docker-sandboxed execution environment. 
This plan sets up the project structure, defines the agent's container environment, and implements custom language handlers for Open Interpreter that redirect all code execution to the sandbox.

Purpose: Protect the host system from potentially destructive or unintended agent actions.
Output: A working Docker sandbox manager and language bridge for Open Interpreter.
</objective>

<execution_context>
@/home/brassy/.gemini/get-shit-done/workflows/execute-plan.md
@/home/brassy/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-secure-execution/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project Scaffold & Sandbox Manager</name>
  <files>requirements.txt, src/sandbox/manager.py</files>
  <action>
    Initialize the project structure and create the `SandboxManager` class.
    - Create `requirements.txt` with: `pydantic-ai`, `open-interpreter`, `docker`, `sqlalchemy`, `aiosqlite`, `pydantic-settings`, `pytest`.
    - Implement `src/sandbox/manager.py` using `docker-py` (the `docker` library).
    - `SandboxManager` must provide:
      - `get_or_create_container()`: Pulls a base image (e.g., `python:3.11-slim-bookworm`), starts a persistent container with a tail command, and sets up a volume mount for `/workspace`.
      - `stop_container()`: Cleans up the container.
      - Error handling for Docker connection issues.
    - Ensure the container runs as a non-root user if possible, or handles UID/GID mapping to avoid file permission issues on the host.
  </action>
  <verify>
    <automated>python3 -c "from src.sandbox.manager import SandboxManager; sm = SandboxManager(); c = sm.get_or_create_container(); print(c.status); sm.stop_container()"</automated>
    <manual>Run the verification command and ensure a container is created and then removed.</manual>
    <sampling_rate>once after implementation</sampling_rate>
  </verify>
  <done>SandboxManager can successfully manage the lifecycle of a Docker container.</done>
</task>

<task type="auto">
  <name>Task 2: Docker Language Implementation</name>
  <files>src/sandbox/languages.py, Dockerfile, tests/test_languages.py</files>
  <action>
    Implement custom Language classes for Open Interpreter that route execution to Docker.
    - Create a `Dockerfile` for the agent:
      - Base: `python:3.11-slim-bookworm`
      - Install basic tools: `curl`, `git`, `procps`.
      - Create `/workspace` directory.
    - Implement `src/sandbox/languages.py`:
      - `DockerPython` and `DockerShell`: Implement the Open Interpreter Language interface. 
      - **CRITICAL:** These classes MUST use the container instance provided by `SandboxManager`.
      - `DockerPython`: Routes `run(code)` to `container.exec_run(["python3", "-c", code])`.
      - `DockerShell`: Routes commands to `container.exec_run(["/bin/bash", "-c", command])`.
    - Create `tests/test_languages.py`:
      - Test `DockerShell` by running `echo "hello"` and asserting the output contains "hello".
      - Test `DockerPython` by running `print(1+1)` and asserting the output contains "2".
      - Ensure these tests use a managed container for the duration of the test.
  </action>
  <verify>
    <automated>pytest tests/test_languages.py</automated>
    <manual>N/A</manual>
    <sampling_rate>once after implementation</sampling_rate>
  </verify>
  <done>Docker-backed languages for Python and Shell are implemented and functional.</done>
</task>

<task type="auto">
  <name>Task 3: Sandbox Isolation Verification</name>
  <files>tests/verify_sandbox.py</files>
  <action>
    Create a verification script to prove the sandbox is working as intended.
    - The script should attempt to:
      1. Run `whoami` inside the container.
      2. List files in `/` and verify they look like a container root, not host root.
      3. Try to access a sensitive host file (e.g., `/etc/shadow`) and verify it fails or sees the container's version.
      4. Create a file in `/workspace` and verify it appears in the host's mapped directory.
  </action>
  <verify>
    <automated>python3 tests/verify_sandbox.py</automated>
    <manual>Confirm that all isolation checks pass.</manual>
    <sampling_rate>once after implementation</sampling_rate>
  </verify>
  <done>Sandbox isolation is verified and documented.</done>
</task>

</tasks>

<verification>
- SandboxManager successfully initializes container.
- DockerShell and DockerPython execute correctly within the container.
- Isolation test script passes all checks.
</verification>

<success_criteria>
- A developer can run code inside a Docker container using the provided manager and languages.
- The host system remains protected from code executed through these classes.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-secure-execution/01-01-SUMMARY.md`
</output>
