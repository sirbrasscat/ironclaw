---
phase: 04-workspace-file-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: ["src/web_ui.py", "src/agent/tools/workspace.py"]
autonomous: true
requirements: ["ENG-03", "WEB-03"]

must_haves:
  truths:
    - "User can see a list of files by typing /files in the chat."
    - "Each listed file is downloadable directly from the UI."
    - "New files created by the agent are automatically presented for download."
  artifacts:
    - path: "src/web_ui.py"
      provides: "Command handler for /files and auto-linking logic"
    - path: "src/agent/tools/workspace.py"
      provides: "Utility to compare workspace snapshots"
  key_links:
    - from: "src/web_ui.py"
      to: "src/agent/tools/workspace.py"
      via: "list_workspace_files and new snapshot tools"

<objective>
Provide a visual way for users to see and download files from the workspace via the Chainlit UI. This includes a manual command (/files) and automatic discovery of new files created by the agent.

Purpose: Bridging the gap between the agent's internal workspace (Docker sandbox) and the user's browser.
Output: Integrated file exploration and download capabilities in the web interface.
</objective>

<execution_context>
@/home/brassy/.gemini/get-shit-done/workflows/execute-plan.md
@/home/brassy/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-workspace-file-management/04-01-SUMMARY.md
@src/web_ui.py
@src/agent/tools/workspace.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace snapshot utilities</name>
  <files>src/agent/tools/workspace.py</files>
  <action>
    Add a `get_workspace_snapshot()` function that returns a set of filenames and their modification times (or just filenames for simplicity).
    Add `get_workspace_diff(old_snapshot, new_snapshot)` that returns a list of files that were added or modified.
    This makes the logic testable outside of the UI.
  </action>
  <verify>
    <automated>python3 -c "from src.agent.tools.workspace import get_workspace_snapshot, get_workspace_diff; s1 = get_workspace_snapshot(); open('./workspace/test_diff.txt', 'w').close(); s2 = get_workspace_snapshot(); diff = get_workspace_diff(s1, s2); assert 'test_diff.txt' in diff; print('Snapshot diff logic works')"</automated>
  </verify>
  <done>Utility functions are implemented and verified to detect file changes.</done>
</task>

<task type="auto">
  <name>Task 2: Implement /files command and auto-linking</name>
  <files>src/web_ui.py</files>
  <action>
    Modify `on_message` in `src/web_ui.py`:
    1. Check if `message.content == "/files"`. If so, use `list_workspace_files()` and send a message with `cl.File` elements for all files.
    2. In the normal agent execution path, take a `get_workspace_snapshot()` before calling the agent.
    3. After the agent run (and after `handle_code_approval` if applicable), take a new snapshot.
    4. Calculate the diff and, if new/modified files are found, send a summary message with `cl.File` elements for those files.
    5. Update `cl.on_chat_start` to add a `cl.Starter` for the "/files" command so it is discoverable.
  </action>
  <verify>
    <automated>grep -q "/files" src/web_ui.py && grep -q "get_workspace_snapshot" src/web_ui.py</automated>
    <manual>Start the app, upload a file, run /files to see it listed. Ask the agent to 'create a file named hello.txt'. Verify it appears as a download link automatically after the agent finishes.</manual>
  </verify>
  <done>UI supports manual and automatic file listing/downloading.</done>
</task>

</tasks>

<verification>
Check that workspace files are correctly mapped to Chainlit elements and that the user can interact with them.
</verification>

<success_criteria>
1. User can view a file list in the UI showing the current contents of the agent's workspace via `/files`.
2. User can download any files created or modified by the agent directly from the UI (either via the list or auto-links).
</success_criteria>

<output>
After completion, create `.planning/phases/04-workspace-file-management/04-02-SUMMARY.md`
</output>
